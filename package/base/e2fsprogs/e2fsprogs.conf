#!/bin/bash
# --- ROCK-COPYRIGHT-NOTE-BEGIN ---
# 
# This copyright note is auto-generated by ./scripts/Create-CopyPatch.
# Please add additional copyright information _after_ the line containing
# the ROCK-COPYRIGHT-NOTE-END tag. Otherwise it might get removed by
# the ./scripts/Create-CopyPatch script. Do not edit this copyright text!
# 
# ROCK Linux: rock-src/package/base/e2fsprogs/e2fsprogs.conf
# ROCK Linux is Copyright (C) 1998 - 2006 Clifford Wolf
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version. A copy of the GNU General Public
# License can be found at Documentation/COPYING.
# 
# Many people helped and are helping developing ROCK Linux. Please
# have a look at http://www.rocklinux.org/ and the Documentation/TEAM
# file for details.
# 
# --- ROCK-COPYRIGHT-NOTE-END ---

libdir="$root/$multilib"
sbindir="$instroot/sbin"
var_append confopt " " "sbindir=${sbindir#$root}"

# var_append extraconfopt " " '--with-root-prefix=$instroot/'
var_append extraconfopt " " '--enable-fsck --enable-elf-shlibs --disable-evms'
# var_append extraconfopt " " '--with-cc="$CC" --with-linker="$LD"'

if [ "$ROCKCFG_DIETLIBC_e2fsprogs" == "1" ] ; then
	var_append extraconfopt " " "--with-diet-libc"
	[ "$dietlibc_dynamic_static" = "dynamic" ] && \
		var_append extraconfopt " " "--enable-dynamic-e2fsck"
fi	

if [ "$ROCKCFG_PKG_UCLIBC_USEIT" == "1" ] ; then
	# e2fsprogs needs a ___tls_get_addr symbol in libc when using TLS
	var_append extraconfopt " " "--disable-tls"
fi

hook_add premake 3 "chmod -v 0755 configure ; \
	cp -v configure{,.orig} ; \
	sed -e \"/libdir=.*\/lib/s@/lib@/$multilib@g\" configure.orig > configure"

# if you are brave, try without this and fix it...
LD="$CC"

# somehow "make install" seems not to execute install-libs, which
# is needed to get the headers installed (and static libraries also)
var_append makeinstopt ' ' "install-libs"

# install config file, move *.so symlinks and make them relative to /usr/lib.
postinstall='install -m 0644 ${confdir}/e2fsck.conf $sysconfdir ;
	for x in com_err ss e2p uuid ext2fs blkid ; do
		ln -svf ../..`readlink $libdir/lib${x}.so` $root/$prefix/$multilib/lib${x}.so ;
		rm -f $libdir/lib${x}.so ;
	done'
