# --- ROCK-COPYRIGHT-NOTE-BEGIN ---
# 
# This copyright note is auto-generated by ./scripts/Create-CopyPatch.
# Please add additional copyright information _after_ the line containing
# the ROCK-COPYRIGHT-NOTE-END tag. Otherwise it might get removed by
# the ./scripts/Create-CopyPatch script. Do not edit this copyright text!
# 
# ROCK Linux: rock-src/package/base/subversion/subversion.conf
# ROCK Linux is Copyright (C) 1998 - 2006 Clifford Wolf
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version. A copy of the GNU General Public
# License can be found at Documentation/COPYING.
# 
# Many people helped and are helping developing ROCK Linux. Please
# have a look at http://www.rocklinux.org/ and the Documentation/TEAM
# file for details.
# 
# --- ROCK-COPYRIGHT-NOTE-END ---

autogen=1
autoextract=0

hook_add preconf 5 svn_extract

svn_extract()
{
	tar --use-compress-program=bunzip2 -xvf $archdir/subversion-$ver.tar.bz2
	tar --use-compress-program=bunzip2 -xvf $archdir/subversion-deps-$ver.tar.bz2

	cd subversion-$ver
}

# use system wide neon
pkginstalled neon && var_append extraconfopt " " "--with-neon=$root/usr"
pkginstalled neon && var_append extraconfopt " " "--disable-neon-version-check"

# please double-check this one:
# pkginstalled apache:apr && var_append extraconfopt " " "--with-apr=$root/usr"
pkginstalled sun-jdk14 && var_append extraconfopt " " "--enable-javahl --with-jdk=`ls -d1R $root/opt/j2sdk1.4*`"

# all this is to build the apache server-side module
# and to make sure no locally included APR stuff get's installed
# as well as no modification to httpd.conf is done ...
if pkginstalled apache; then
	apacheprefix=${ROCKCFG_PKG_APACHE_PREFIX:-opt/apache}
	var_append extraconfopt " " "--with-apxs=/$apacheprefix/sbin/apxs \
		--with-apr=/$apacheprefix/bin/apr-1-config --with-apr-util=/$apacheprefix \
		--disable-mod-activation"
	if [ "$ROCKCFG_PKG_APACHE_BDB" ] ; then
		var_append extraconfopt " " \
		  "--with-berkeley-db=db.h:/usr/include/${ROCKCFG_PKG_APACHE_BDB#b}:/usr/lib:${ROCKCFG_PKG_APACHE_BDB#b}"
	fi
fi

# build and install perl bindings
svn_inst_pl() {
	make swig-pl-lib
	cd subversion/bindings/swig/perl/native
	perl Makefile.PL; make all
	make -C $OLDPWD install-swig-pl-lib
	make install; cd $OLDPWD
}

# build and install python bindings
svn_inst_py() {
	make swig-py
	make install-swig-py
}

# build and install java bindings
svn_inst_java() {
	make javahl
	make install-javahl
}

# install etc/profile.d/subversion
svn_inst_profile() {
	cat > $root/etc/profile.d/subversion <<-EOF
export PYTHONPATH=\$PYTHONPATH\${PYTHONPATH:+:}/$prefix/lib/svn-python
EOF
}

# hotfix, without this "perl -e 'use SVN::Core'" (and others?) do not work
export LIBS="-lz -lssl"

hook_add postmake 3 "install_init svnserve $confdir/svnserve.init"
hook_add postmake 4 "cp -vrf tools $docdir"

# if swig is present build and install the perl and python bindings
pkginstalled swig && [ -n "$( type -p perl   )" ] && hook_add postmake 5 "svn_inst_pl"
pkginstalled swig && [ -n "$( type -p python )" ] && hook_add postmake 5 "svn_inst_py"
# if java is present, install java bindings
pkginstalled sun-jdk14 && hook_add postmake 5 "svn_inst_java"

hook_add postmake 5 "svn_inst_profile"

if pkginstalled apache ; then
	splitdesc_apache() {
		desc_I="Apache module for subversion"
	}
	splitreg 50 apache ${apacheprefix}.*mod_.*so
fi
splitdesc_server() {
	desc_I="$desc_I (server binaries)"
}
splitdesc_java() {
	desc_I="$desc_I (java bindings)"
}
splitreg 51 server /svn[^.]\+[^th]$
splitreg 52 server rc\.d
splitreg 53 java java

# Quick & Dirty hack for the perllocal problem
. $base/package/base/perl5/perllocal_hack.sh

