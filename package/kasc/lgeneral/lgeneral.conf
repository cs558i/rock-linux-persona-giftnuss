
# --- ROCK-COPYRIGHT-NOTE-BEGIN ---
# 
# This copyright note is auto-generated by ./scripts/Create-CopyPatch.
# Please add additional copyright information _after_ the line containing
# the ROCK-COPYRIGHT-NOTE-END tag. Otherwise it might get removed by
# the ./scripts/Create-CopyPatch script. Do not edit this copyright text!
# 
# ROCK Linux: rock-src/package/kasc/lgeneral/lgeneral.conf
# ROCK Linux is Copyright (C) 1998 - 2006 Clifford Wolf
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version. A copy of the GNU General Public
# License can be found at Documentation/COPYING.
# 
# Many people helped and are helping developing ROCK Linux. Please
# have a look at http://www.rocklinux.org/ and the Documentation/TEAM
# file for details.
# 
# --- ROCK-COPYRIGHT-NOTE-END ---

bindir=$root/$ROCKCFG_PKG_GAMES_BINDIR
datadir=$root/$ROCKCFG_PKG_GAMES_DATADIR

lgeneral_pm() {
	tar $taropt $archdir/pg-data.tar.bz2

	mkdir -p $datadir/lgeneral/{nations,gfx/flags,units,gfx/units,maps}
	mkdir -p $datadir/lgeneral/{gfx/terrain/pg,sounds/pg,scenarios/pg}

	# Ok. This might be one of the ugliest hacks I've ever made for a ROCK
	# Linux package.. this app needs an X-display for running the 'lgc-pg'
	# binary. So we create a temporary Xvfb process and register it as X-server
	# number 42. Let's hope that there isn't already another X-server using
	# the same ID ...  (Clifford)

	echo "Starting Xvfb server .."
	Xvfb :42 -fbdir . -screen 0 640x480x15 &
	xvfb_pid=$!

	lgcpgrun=1
	if DISPLAY=:42.0 $bindir/lgc-pg -s pg-data -d $datadir/lgeneral | \
		tee /proc/self/fd/2 | grep -q 'Done!'
	then lgcpgrun=0; fi

	echo "Killing Xvfb server .."
	kill -9 $xvfb_pid

	if [ $lgcpgrun -ne 0 ]; then
		echo "Got error from '$bindir/lgc-pg -s pg-data -d $datadir/lgeneral' !!"
		false
	fi
}

hook_add postmake 3 lgeneral_pm

