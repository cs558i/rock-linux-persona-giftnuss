#!/bin/bash
# --- ROCK-COPYRIGHT-NOTE-BEGIN ---
# 
# This copyright note is auto-generated by ./scripts/Create-CopyPatch.
# Please add additional copyright information _after_ the line containing
# the ROCK-COPYRIGHT-NOTE-END tag. Otherwise it might get removed by
# the ./scripts/Create-CopyPatch script. Do not edit this copyright text!
# 
# ROCK Linux: rock-src/package/x11/qt/qt.conf
# ROCK Linux is Copyright (C) 1998 - 2006 Clifford Wolf
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version. A copy of the GNU General Public
# License can be found at Documentation/COPYING.
# 
# Many people helped and are helping developing ROCK Linux. Please
# have a look at http://www.rocklinux.org/ and the Documentation/TEAM
# file for details.
# 
# --- ROCK-COPYRIGHT-NOTE-END ---

if [ $prefix_auto = 1 ] ; then
	prefix="opt/$xpkg"
	set_confopt
fi
if [ $xpkg == qt4 ] ; then
	 splitdesc_debug() { desc_I="Qt debug libraries"; }
	 splitreg 10 debug $prefix/lib/.+_debug
	 splitreg 41 dev $prefix/examples/
fi

qt_pass() {
	QTDIR=$PWD
	var_insert LD_LIBRARY_PATH ':' "$QTDIR/lib"
	var_insert PATH ':' "$QTDIR/bin"
	export QTDIR LD_LIBRARY_PATH PATH

	# Qt only supports some selected options ...
	confopt="$1 -prefix $root/$prefix -bindir $bindir -libdir $libdir \
		 -docdir $docdir -sysconfdir $sysconfdir"

	# config options used by all qt versions
	var_append confopt " " "-no-exceptions"
	var_append confopt " " "-qt-gif"
	pkginstalled nas && var_append confopt " " "-system-nas-sound"
	pkginstalled mysql && var_append confopt " " "-plugin-sql-mysql \
		-I$pkg_mysql_prefix/include/mysql -L$pkg_mysql_prefix/lib"
	# pkginstalled postgresql && var_append confopt " " "-plugin-sql-psql \
	# -I$pkg_postgresql_prefix/include" # maybe more

       if [ $xpkg == qt3 ]; then
		 var_append CXXFLAGS " " "-I/usr/X11/include"
		 pkginstalled libmng && var_append confopt " " "-system-libmng"
		 var_append confopt " " "-thread"
		 var_append confopt " " "-xft"
		 var_append confopt " " "-xrender"
		 pkginstalled zlib && var_append confopt " " "-system-zlib"
		 pkginstalled libpng && var_append confopt " " "-system-libpng"
		 pkginstalled libjpeg && var_append confopt " " "-system-libjpeg"
	elif [ $xpkg == qt4 ]; then
		 pkginstalled postgresql && var_append confopt " " "-plugin-sql-psql \
		  -I$pkg_postgresql_prefix/include -L$pkg_postgresql_prefix/lib"
 	fi

	# an optimization crashes g++ during the Makefile generator build :-(
	echo "yes" | ( CXX_WRAPPER_BYPASS=1 ; ./configure $confopt )

	eval $MAKE ; eval $MAKE install

	# create compatibility links ...
	(
	cd $root/$prefix/lib/
	for x in libqt-mt.so*
	do
		ln -svf $x ${x/-mt}
	done
	[ -f libqt-mt.a ] && ln -svf libqt-mt.a libqt.a
	)
	
    echo "Copy some documentation ..."
	if [ $xpkg == qt3 ] ; then
		cp -a ch* tutorial $docdir/
	elif [ $xpkg == qt4 ] ; then
		cp -a changes-$ver $docdir/
	fi
	
	find $docdir -name '*.o' | xargs rm -vf
	find $docdir -type f -perm +111 -exec strip -v '{}' \;
	
	cat > $root/etc/profile.d/$xpkg <<-EOT
		QT${xpkg:2:1}DIR=/$prefix
		export QT${xpkg:2:1}DIR
	EOT
	# until kde 4 which will be based on qt4 the standard is qt3 here
	if [ $xpkg == "$ROCKCFG_PKG_QT_DEFAULT" ]; then
		cat >> $root/etc/profile.d/$xpkg <<-EOT
			QTDIR=\$QT${xpkg:2:1}DIR
			export QTDIR
		EOT
	fi
}

qt_main() {
	if [ "$ROCKCFG_PKG_QT_STATIC" = "1" ] ; then
		echo "running -static build-pass..."
		qt_pass -static
	fi
	echo "running -shared build-pass..."
	qt_pass
}

createdocs=0
custmain=qt_main
